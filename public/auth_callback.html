<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Auth Callback</title>
</head>
<body>
  <pre id="log" style="font-family:monospace;padding:12px">Finalizando login…</pre>
  <script type="module">
    const log = (...a) => (document.getElementById('log').textContent += "\n" + a.map(x=>typeof x==='object'?JSON.stringify(x):String(x)).join(' '), console.log(...a));

    // ✅ Use os MESMOS valores do app (ou injete via placeholder e build)
    const SUPABASE_URL  = 'https://ityisebfxsvwmaophyxsn.supabase.co';
    const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml0eWlzZWJmeHN2d21hb3BoeHNuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYzODU0OTIsImV4cCI6MjA3MTk2MTQ5Mn0.uP3FPdAVRTolGqdQtHtJeEMjR6fwqERg6xnWzj-BONQ';

    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON, {
      auth: {
        flowType: 'pkce',
        persistSession: true,
        autoRefreshToken: true,
        storageKey: 'sb-i2sales-auth', // ⚠️ igual ao do app
      },
    });

    // 1) Trocar ?code por sessão
    try {
      log('[cb] href', window.location.href);
      const { data, error } = await supabase.auth.exchangeCodeForSession(window.location.href);
      if (error) { log('[cb] exchange error', error.message); throw error; }
      log('[cb] exchange ok, has user?', !!data.session?.user);

      // 2) Sanity: ler sessão imediatamente
      const now = await supabase.auth.getSession();
      log('[cb] getSession after exchange user?', !!now.data.session?.user, now.data.session?.user?.email || '');

      // 3) Redirecionar
      location.replace('/#/dashboard');
    } catch (e) {
      log('[cb] FAIL', e?.message || e);
      location.replace('/#/login');
    }
  </script>
</body>
</html>